import React, { useState } from 'react';
import Spinner from '../components/Spinner';

const MalwareDetection = () => {
  const [file, setFile] = useState(null);
  const [hashInput, setHashInput] = useState('e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855');
  const [analysisStatus, setAnalysisStatus] = useState('');
  const [analysisResult, setAnalysisResult] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  const handleFileUpload = (event) => {
    const selectedFile = event.target.files[0];
    setFile(selectedFile);
    setAnalysisStatus('');
    setAnalysisResult('');
  };

  const startFileAnalysis = () => {
    if (!file) {
      setAnalysisStatus('분석할 파일을 먼저 선택해주세요.');
      return;
    }

    setIsAnalyzing(true);
    setAnalysisStatus(`'${file.name}' 해시 추출 및 분석 요청 중...`);
    setAnalysisResult('분석 중...');

    setTimeout(() => {
      const mockHash = 'a1b2c3d4e5f67890abcdef1234567890';
      const isMalicious = Math.random() > 0.7;

      setAnalysisStatus(`분석 완료. 해시: ${mockHash.substring(0, 10)}...`);
      setIsAnalyzing(false);

      if (isMalicious) {
        setAnalysisResult(`
          <h4 class="text-lg font-bold text-danger">🚨 악성 파일 탐지됨 (Ransomware.Gen)</h4>
          <p class="text-sm text-gray-300 mt-2">이 파일은 다수의 안티바이러스 엔진에서 랜섬웨어 변종으로 보고되었습니다. 감염 경로 및 영향을 받은 시스템을 즉시 격리하십시오.</p>
          <p class="text-xs text-gray-500 mt-2">파일 이름: ${file.name}<br>SHA-256: ${mockHash}</p>
        `);
      } else {
        setAnalysisResult(`
          <h4 class="text-lg font-bold text-safe">✅ 안전함 (Clean)</h4>
          <p class="text-sm text-gray-300 mt-2">전역 위협 데이터베이스에서 악성코드로 식별되지 않았습니다.</p>
          <p class="text-xs text-gray-500 mt-2">파일 이름: ${file.name}<br>SHA-256: ${mockHash}</p>
        `);
      }
    }, 5000);
  };

  const startHashAnalysis = () => {
    if (hashInput.length !== 64) {
      setAnalysisStatus('유효한 SHA-256 해시(64자)를 입력해주세요.');
      return;
    }

    setIsAnalyzing(true);
    setAnalysisStatus(`해시 ${hashInput.substring(0, 10)}... 분석 요청 중...`);
    setAnalysisResult('분석 중...');

    setTimeout(() => {
      const isMalicious = !hashInput.startsWith('e3b0c44');

      setAnalysisStatus('분석 완료.');
      setIsAnalyzing(false);

      if (isMalicious) {
        setAnalysisResult(`
          <h4 class="text-lg font-bold text-danger">🚨 악성 해시 탐지됨 (WannaCry Variant)</h4>
          <p class="text-sm text-gray-300 mt-2">이 해시는 'WannaCry' 랜섬웨어 변종과 일치합니다. 감염되었을 가능성이 높으므로 즉시 조치해야 합니다.</p>
          <p class="text-xs text-gray-500 mt-2">SHA-256: ${hashInput}</p>
        `);
      } else {
        setAnalysisResult(`
          <h4 class="text-lg font-bold text-safe">✅ 안전함 (Clean)</h4>
          <p class="text-sm text-gray-300 mt-2">전역 위협 데이터베이스에서 악성코드로 식별되지 않았습니다.</p>
          <p class="text-xs text-gray-500 mt-2">SHA-256: ${hashInput}</p>
        `);
      }
    }, 3000);
  };

  return (
    <section>
      <h1 className="text-3xl font-bold mb-6 text-white">악성코드 해시 검증 모듈</h1>
      
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Column 1: File Upload & Manual Hash Check */}
        <div className="bg-dark-card p-6 rounded-xl shadow-2xl space-y-6">
          <h2 className="text-xl font-semibold border-b border-gray-700 pb-3">수동 분석 & 파일 업로드</h2>

          {/* 1. File Upload */}
          <div>
            <h3 className="font-medium text-lg mb-2">파일 업로드 분석</h3>
            <p className="text-sm text-gray-400 mb-3">파일 자체를 업로드하여 해시를 추출하고 분석을 요청합니다.</p>
            <div className="flex space-x-4">
              <input 
                type="file" 
                id="file-upload-input" 
                className="hidden" 
                onChange={handleFileUpload}
              />
              <label 
                htmlFor="file-upload-input" 
                className="flex-1 p-3 bg-dark-bg border border-gray-600 rounded-lg text-sm text-gray-400 cursor-pointer flex items-center justify-between hover:border-accent transition duration-150"
              >
                <span>
                  {file ? `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB) 선택됨` : '파일을 선택하거나 드래그하세요...'}
                </span>
                <span className="bg-accent text-dark-bg px-3 py-1 rounded-md font-medium text-xs">선택</span>
              </label>
              <button 
                onClick={startFileAnalysis}
                className="px-6 py-3 bg-danger hover:bg-red-700 text-white rounded-lg font-bold transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled={!file}
              >
                분석 시작
              </button>
            </div>
            {analysisStatus && (
              <div className="mt-2 text-sm text-gray-400 flex items-center">
                {isAnalyzing && <Spinner />}
                <span className={isAnalyzing ? 'ml-2' : ''}>{analysisStatus}</span>
              </div>
            )}
          </div>

          {/* 2. Hash Input */}
          <div>
            <h3 className="font-medium text-lg mb-2 pt-4 border-t border-gray-800">해시 직접 입력 분석</h3>
            <p className="text-sm text-gray-400 mb-3">SHA-256 해시 값을 입력하여 분석합니다.</p>
            <div className="flex space-x-4">
              <input 
                type="text" 
                placeholder="SHA-256 해시 값 입력" 
                className="flex-1 p-3 bg-dark-bg border border-gray-600 rounded-lg focus:ring-danger focus:border-danger text-sm"
                value={hashInput}
                onChange={(e) => setHashInput(e.target.value)}
              />
              <button 
                onClick={startHashAnalysis}
                className="px-6 py-3 bg-danger hover:bg-red-700 text-white rounded-lg font-bold transition duration-150"
              >
                탐지 실행
              </button>
            </div>
          </div>
        </div>

        {/* Column 2: Status & Results */}
        <div className="bg-dark-card p-6 rounded-xl shadow-2xl space-y-6">
          <h2 className="text-xl font-semibold border-b border-gray-700 pb-3">탐지 현황 및 결과</h2>

          {/* 3. Automated Detection Status */}
          <div>
            <h3 className="font-medium text-lg mb-2">자동 탐지/스케줄링 현황</h3>
            <div className="p-4 bg-dark-bg rounded-lg border border-accent/50">
              <div className="flex items-center justify-between mb-2">
                <span className="text-accent font-semibold flex items-center">
                  <Spinner />
                  <span className="ml-2">실시간 모니터링 활성화</span>
                </span>
                <span className="text-xs text-gray-400">다음 스케줄: 03:00 AM</span>
              </div>
              <p className="text-sm text-gray-400">
                최근 시스템 검사: 5시간 전 완료. 1개 의심 파일 발견.
              </p>
            </div>
          </div>
          
          {/* 4. Summary Grid */}
          <div>
            <h3 className="font-medium text-lg mb-2 pt-4 border-t border-gray-800">누적 탐지 결과 요약</h3>
            <div className="grid grid-cols-3 gap-3">
              <div className="p-4 bg-dark-bg rounded-lg border border-safe/50 text-center">
                <p className="text-3xl font-extrabold text-safe">85</p>
                <p className="text-xs text-gray-400 mt-1">안전 파일 (정상)</p>
              </div>
              <div className="p-4 bg-dark-bg rounded-lg border border-caution/50 text-center">
                <p className="text-3xl font-extrabold text-caution">12</p>
                <p className="text-xs text-gray-400 mt-1">의심 파일 (검역 필요)</p>
              </div>
              <div className="p-4 bg-dark-bg rounded-lg border border-danger/50 text-center">
                <p className="text-3xl font-extrabold text-danger">3</p>
                <p className="text-xs text-gray-400 mt-1">악성 파일 (차단 완료)</p>
              </div>
            </div>
          </div>

          {/* 5. Analysis Result */}
          <div className="pt-4 border-t border-gray-800">
            <h3 className="text-lg font-semibold mb-2">상세 분석 결과</h3>
            <div className="p-4 bg-dark-bg rounded-lg border border-gray-700">
              {analysisResult ? (
                <div dangerouslySetInnerHTML={{ __html: analysisResult }} />
              ) : (
                <p className="text-gray-400 text-sm">탐지/분석 실행 후, 해당 파일/해시 값에 대한 분석 정보가 여기에 표시됩니다.</p>
              )}
            </div>
          </div>
        </div>
      </div>
    </section>
  );
};

export default MalwareDetection;
